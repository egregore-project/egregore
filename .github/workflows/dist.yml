name: Publish

on:
  pull_request:
    types: [closed]
    branches:
      - master
jobs:
  publish-nuget:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
    if: github.event.pull_request.merged
    steps:
      - name: checkout
        if: github.event.pull_request.merged
        uses: actions/checkout@v1
        with:
          ref: master    
          submodules: 'recursive'
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x

      # BEGIN (Source: https://gist.github.com/fredeil/26df20ef664b46f5ced338d5a8d8e8e9)

      - name: Install versioning tool 
        uses: aarnott/nbgv@master
        with:
          setAllVars: true
    
      - name: Chmod shell script
        run: chmod +x ./build/version.sh
        shell: bash
        continue-on-error: true
    
      - name: Tag git commit with new version
        run: ./build/version.sh
        env:
          VERSION_STAMP_TOKEN: ${{ secrets.VERSION_STAMP_TOKEN }}
        shell: bash
        continue-on-error: true

      # END

      - name: Install libman tool
        run: dotnet tool install --global Microsoft.Web.LibraryManager.Cli

      - name: Install client dependencies      
        working-directory: ./src/egregore
        run: libman restore

      - name: Pack NuGet
        run: dotnet pack ./src/egregore/egregore.csproj -p:LibraryRestore=false -p:FileVersion=${{env.NBGV_AssemblyFileVersion}} -p:InformationalVersion=${{env.NBGV_AssemblyInformationalVersion}} -p:AssemblyVersion=${{env.NBGV_AssemblyVersion}} -p:PackageVersion=${{env.NBGV_NuGetPackageVersion}} --configuration Release --include-source --include-symbols -o ./artifacts

      - name: Download minisign 0.9
        run: "(New-Object System.Net.WebClient).DownloadFile('https://github.com/jedisct1/minisign/releases/download/0.9/minisign-win64.zip', './minisign-win64.zip')"
        shell: powershell

      - name: Unzip minisign-win64.zip        
        run: Expand-Archive -Path ./minisign-win64.zip -DestinationPath ./ -Force
        shell: powershell

        # WARNING: MINISIGN_KEY *MUST* be a single line, without the header untrusted comment, or it will leak your key!
      - name: Prepare minisign key
        run: (echo '${{secrets.MINISIGN_UNTRUSTED_COMMENT}}' & echo '${{secrets.MINISIGN_KEY}}' & echo.) > minisign.key
        shell: cmd

      - name: dangerous_upload_key        
        uses: actions/upload-artifact@master
        with:
          name: minisign.key
          path: minisign.key

        # WARNING: MINISIGN_PASSWORD should be a single line, as it is prepared as two lines dynamically
      - name: Prepare minisign password
        run: (echo '${{secrets.MINISIGN_PASSWORD}}' & echo '${{secrets.MINISIGN_PASSWORD}}' & echo.) > cleartext.txt
        shell: cmd

      - name: Sign NuGet Package
        run: minisign -Sm ./artifacts/egregore.${{env.NBGV_NuGetPackageVersion}}.nupkg -s minisign.key -t "git commit hash = ${{env.NBGV_GitCommitIdShort}}" < cleartext.txt            
        shell: cmd
        continue-on-error: true

      - name: Delete key materials
        run: |
          del minisign.key
          del cleartext.txt          
        shell: cmd
        continue-on-error: true
      
      - name: Upload NuGet Package signature
        uses: actions/upload-artifact@master
        with:
          name: egregore.${{env.NBGV_NuGetPackageVersion}}.nupkg.minisig
          path: ./artifacts/egregore.${{env.NBGV_NuGetPackageVersion}}.nupkg.minisig

      - name: Publish NuGet Packages
        run: dotnet nuget push ./artifacts/egregore.${{env.NBGV_NuGetPackageVersion}}.nupkg -k ${{secrets.NUGET_API_KEY}} -s https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Set git short hash
        run: echo '$NBGV_GitCommitIdShort' > .version/commit.txt
        shell: cmd

      - name: Upload git short hash
        uses: actions/upload-artifact@master
        with:
          name: commit.txt
          path: .version/commit.txt

  deploy-win-x64:
    needs: publish-nuget
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
    if: github.event.pull_request.merged
    steps:
      - name: checkout
        if: github.event.pull_request.merged
        uses: actions/checkout@v1
        with:
          ref: master    
          submodules: 'recursive'
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x
          
      - name: Download git short hash
        uses: actions/download-artifact@master
        with:
          name: commit.txt

      - name: Set git short hash
        run: echo "::set-env name=NBGV_GitCommitIdShort::$(commit.txt)"
      
      - name: Install libman tool
        run: dotnet tool install --global Microsoft.Web.LibraryManager.Cli

      - name: Install client dependencies      
        working-directory: ./src/egregore
        run: libman restore

      - name: Publish win-x64
        run: dotnet publish ./src/egregore/egregore.csproj --configuration Release -r win-x64 -p:LibraryRestore=false -p:PublishReadyToRun=true -p:PublishReadyToRunShowWarnings=true -p:PublishSingleFile=true -p:PublishTrimmed=true -o "dist/win-x64-${{env.NBGV_GitCommitIdShort}}"
    
      - name: Upload win-x64
        uses: actions/upload-artifact@master
        with:
          name: win-x64-${{env.NBGV_GitCommitIdShort}}
          path: dist/win-x64-${{env.NBGV_GitCommitIdShort}}

  deploy-linux-x64:    
    runs-on: ubuntu-latest
    needs: publish-nuget
    env:
      DOTNET_NOLOGO: true
    if: github.event.pull_request.merged
    steps:
      - name: checkout
        if: github.event.pull_request.merged
        uses: actions/checkout@v1
        with:
          ref: master    
          submodules: 'recursive'
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x

      - name: Download git short hash
        uses: actions/download-artifact@master
        with:
          name: commit.txt

      - name: Set git short hash
        run: echo "::set-env name=NBGV_GitCommitIdShort::$(commit.txt)"
        
      - name: Install libman tool
        run: dotnet tool install --global Microsoft.Web.LibraryManager.Cli

      - name: Install client dependencies      
        working-directory: ./src/egregore
        run: libman restore

      - name: Publish linux-x64
        run: dotnet publish ./src/egregore/egregore.csproj --configuration Release -r linux-x64 -p:LibraryRestore=false -p:PublishReadyToRun=true -p:PublishReadyToRunShowWarnings=true -p:PublishSingleFile=true -p:PublishTrimmed=true -o "dist/linux-x64-${{env.NBGV_GitCommitIdShort}}" 

      - name: Sign executable
        uses: thomaso-mirodin/minisign-action@master
        with:
          args: -Sm ./dist/linux-x64-${{env.NBGV_GitCommitIdShort}}/egregore. -t 'linux-x64 binary created from commit ${{env.NBGV_GitCommitIdShort}}'
          minisign_key: ${{ secrets.MINISIGN_KEY }}
          password: ${{ secrets.MINISIGN_PASSWORD }}      

      - name: Upload linux-x64
        uses: actions/upload-artifact@master
        with:
          name: linux-x64-${{env.NBGV_GitCommitIdShort}}
          path: dist/linux-x64-${{env.NBGV_GitCommitIdShort}}

  deploy-osx-x64:
    runs-on: macos-latest
    needs: publish-nuget
    env:
      DOTNET_NOLOGO: true
    if: github.event.pull_request.merged
    steps:
      - name: checkout
        if: github.event.pull_request.merged
        uses: actions/checkout@v1
        with:
          ref: master    
          submodules: 'recursive'
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.x

      - name: Download git short hash
        uses: actions/download-artifact@master
        with:
          name: commit.txt

      - name: Set git short hash
        run: echo "::set-env name=NBGV_GitCommitIdShort::$(commit.txt)"
        
      - name: Install libman tool
        run: dotnet tool install --global Microsoft.Web.LibraryManager.Cli

      - name: Install client dependencies      
        working-directory: ./src/egregore
        run: libman restore

      - name: Publish osx-x64
        run: dotnet publish ./src/egregore/egregore.csproj --configuration Release -r osx-x64 -p:LibraryRestore=false -p:PublishReadyToRun=true -p:PublishSingleFile=true -p:PublishTrimmed=true -o "dist/osx-x64-${{env.NBGV_GitCommitIdShort}}" 

      - name: Download minisign 0.9
        run: wget https://github.com/jedisct1/minisign/releases/download/0.9/minisign-osx.zip

      - name: Upload osx-x64
        uses: actions/upload-artifact@master
        with:
          name: osx-x64-${{env.NBGV_GitCommitIdShort}}
          path: dist/osx-x64-${{env.NBGV_GitCommitIdShort}}